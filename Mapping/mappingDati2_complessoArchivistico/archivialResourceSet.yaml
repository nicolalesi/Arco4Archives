prefixes:
    l0: "https://w3id.org/italia/onto/l0/"
    cov: "https://w3id.org/italia/onto/COV/"
    clv: "https://w3id.org/italia/onto/CLV/"
    prj: "https://w3id.org/italia/onto/Project/"
    rdfs: "http://www.w3.org/2000/01/rdf-schema#"
    xsd: "http://www.w3.org/2000/01/XMLSchema#"
    Arco4Archive: "https://w3id.org/italia/cultural-heritage/archives/onto/"
    data: "https://w3id.org/italia/cultural-heritage/archives/data/"
    ti: "https://w3id.org/italia/onto/TI/"
    grel: "http://users.ugent.be/~bjdmeest/function/grel.ttl#"
    arco-lite: "https://w3id.org/arco/ontology/arco-lite/"
    fno: "https://w3id.org/imec/idlab/function#"
    core: "https://w3id.org/arco/ontology/core/"
    a-cd: "https://w3id.org/arco/ontology/context-description/"  
    a-dd: "https://w3id.org/arco/ontology/denotative-description/"  
    idlab-fn: "https://w3id.org/imec/idlab/function#"
    sm: "https://w3id.org/italia/onto/SM/URL/"


sources:
  data1:
    access: ComplArch.xml
    referenceFormulation: xpath
    iterator: "/ead/archdesc"
  data2:
    access: ComplArch.xml
    referenceFormulation: xpath
    iterator: "//physdescstructured"
  data3:
    access: ComplArch.xml
    referenceFormulation: xpath                   #non utilizzato
    iterator: "/arrangement"
  data4:
    access: ComplArch.xml
    referenceFormulation: xpath
    iterator: "//arrangement"
  data5:
    access: ComplArch.xml
    referenceFormulation: xpath
    iterator: "//subject"
  data6:
    access: ComplArch.xml
    referenceFormulation: xpath
    iterator: "//archdesc/otherfindaid"
  data7:
    access: ComplArch.xml
    referenceFormulation: xpath
    iterator: "//relations/relation"
  archivalHierarchy:
    access: archival_resource_levels.csv
    referenceFormulation: csv
  archivesConsistency:
    access: archives-consistency-type.csv
    referenceFormulation: csv


mappings:
    ArchivialResourceSet:
        sources: 
        # - data2
        #- archivalHierarchy #se lo scommento ho problemi con il subject sottostante
        - data1
        s:  https://w3id.org/italia/cultural-heritage/archives/data/archivial-resource-set/$(did/unitid[1])/
           # function: fno:concat
           # parameters:
           # - [fno:str, "https://w3id.org/italia/cultural-heritage/archives/data/archivial-resource-set/$(did/unitid[1])/"]     #Per coerenza rendo anche il subject dell'Archivial resource codice+title in md5
           # - parameter: fno:otherStr
           #   value:
           #     function: grel:string_md5
           #     parameters:
           #     - [grel:valueParameter:str,"$did/unittitle[1])"]
        po:
        - [a, Arco4Archive:ArchivialResourceSet]
        - [Arco4Archive:hasArchivialReferenceCode, "https://w3id.org/italia/cultural-heritage/archives/data/archivial-reference-code/$(did/unitid[1])~iri"]
        - p: core:hasType
          o: 
          - mapping: LevelOfDescription                                                             #matching con vocabolario controllato
            condition:                                 
              function: equal
              parameters:
                - [str1, $(@level),s]
                - [str2, $(Notation),o]
        - [rdfs:label, "Complesso archivistico $(did/unitid[1])"]
        - [arco-lite:alternativeIdentifier, "$(did/unitid[@localType='altroId'])"]    
        - [arco-lite:alternativeIdentifier, "$(did/unitid[@localType='idPrecedente'])"] 
        - p: arco-lite:currentDesignation
          o:
              function: fno:concat
              parameters:
                - [fno:str,"https://w3id.org/italia/cultural-heritage/archives/data/current-designation/"]
                - parameter: fno:otherStr
                  value:
                    function: fno:slugify                                                                                             #aggiunto slugify
                    parameters:                                                                                                   
                    - [fno:str, "$(did/unittitle[1])"]
              type: iri
        - [arco-lite:alternativeDesignation, "$(did/unittitle[@label='altraDenominazione'])"]
        - p: a-cd:hasDesignationInTime
          o:
            function: fno:concat
            parameters:
              - [fno:str, "https://w3id.org/italia/cultural-heritage/archives/data/alternative-designation/$(did/unitid[1])-"]
              - parameter: fno:otherStr
                value:
                  function: fno:slugify
                  parameters:
                  - [fno:str, "$(did/unittitle[@label='altraDenominazione'])"]
            type: iri 
        - [Arco4Archive:totalExtentInLinearMeters, "$(did/physdesc)",xsd:string]
        - [a-dd:hasConservationStatus, "https://w3id.org/arco/ontology/denotative-description/ConservationStatus/$(did/unitid[1])~iri"]
        - p: ti:atTime
          o:
                function: fno:concat
                parameters: 
                - [fno:str, https://w3id.org/italia/cultural-heritage/archives/data/time-interval/$(did/unitdatestructured/daterange/fromdate)]
                - [fno:delimiter, "-"]
                - [fno:otherStr, $(did/unitdatestructured/daterange/todate)]
                type: iri
        - [core:description, "$(scopecontent/p)"]
        - [a-cd:historicalInformation, "$(custodhist/p)"]
        - [core:specification, $(appraisal/p)]
        - [core:specification, $(accruals/p)]
        - [core:note, $(acquinfo/p)]
        - p: Arco4Archive:hasConditionOfAccess
          o:
            function: fno:concat
            parameters: 
            - [fno:str, https://w3id.org/italia/cultural-heritage/archives/data/condition-of-access/]
            - parameter: fno:otherStr
              value:
                function: grel:string_md5
                parameters:
                - [grel:valueParameter:str, "$(accessrestrict/accessrestrict[@localtype='noteCondizioniAccesso']/p)"]      
            type: iri
        - p: Arco4Archive:hasConditionOfUse
          o:
            function: fno:concat
            parameters: 
            - [fno:str, https://w3id.org/italia/cultural-heritage/archives/data/condition-of-use/]
            - parameter: fno:otherStr
              value:
                function: grel:string_md5
                parameters:
                - [grel:valueParameter:str, "$(userrestrict/userrestrict[@localtype='noteCondizioniUtilizzo']/p)"]      
            type: iri
        - p: Arco4Archive:hasOriginal     
          o:
            function: fno:concat
            parameters:
            - [fno:str, "https://w3id.org/italia/cultural-heritage/archives/data/archivial-resource-set/$(did/unitid[1])/original-location/"]    
            - parameter: fno:otherStr
              value:
                function: grel:string_md5
                parameters:
                - [grel:valueParameter:str,$(originalsloc/p/title/part)]
            type: iri
        - p: Arco4Archive:hasCopy   #Anche qui è una triangolazione, ci sono degli attributi relativi alla relazione
          o:
            function: fno:concat
            parameters:
            - [fno:str, "https://w3id.org/italia/cultural-heritage/archives/data/archivial-resource-set/$(did/unitid[1])/copy-location/"]     
            - parameter: fno:otherStr                                                                                           #da controllare non sonon certa che siano logicamente corrette
              value:                                                                                                            
                function: grel:string_md5                                                                                       #momentaneamente ho aggiunto has-originalo has copy nell'URI, ma non mi piace particolarmente
                parameters:                                                                                                     # se id della risorsa archivistica è lo stesso non può avere più senso fare URI identico a quello dell'ArchivialResource dato che dovrebbe rimandare lì e poi un flag nei dati per dire che è una copia se ha un originale?
                - [grel:valueParameter:str,$(altformavail/p/title/part)]                                                         #non capisco come uri composti diversamente possano ricondurre alla stessa entità
            type: iri
        - p: Arco4Archive:hasExternalDocumentation                                                            #URI: ...data/documentation-relation/md5 id complesso + stringa del titolo della documentazione. arcole qualifica del collegamento che va in  documentationRelation, collegato con core:specification, ha rdfs:label= qualifica della relazione tra risorsa archivistica codice id risorse e della documentazione e titolo della doc
          o:
            function: fno:concat
            parameters:
            - [fno:str, https://w3id.org/italia/cultural-heritage/archives/data/archivial-resource-set/external-related-doc/]
            - parameter: fno:otherStr
              value:
                function: grel:string_md5
                parameters:
                - [grel:valueParameter,$(relatedmaterial/archref/title)]                      #sia nel mapping che nei dati externalDoc avrebbe più dati da mappare, forse non era finita? --- hasExternalDocumentation, documentationRelation
            type: iri                                                                          #sm:url e aggiungiamo l'URL https://w3id.org/italia/onto/SM/   aggiungere anche qualifica del collegamento sm:URL xsd:anyURI
        - p: Arco4Archive:hasInternalDocumentation                          #prendi il codice identificativo per creare l'URI, solo il numero              
          o:
            function: fno:concat
            parameters:
            - [fno:str,"https://w3id.org/italia/cultural-heritage/archives/data/archivial-resource-set/internal-related-doc/"]
            - parameter: fno:otherStr
              value:
                function: fno:slugify
                parameters:
                - [fno:str, "$(relatedmaterial/archref/ref/@target)"]                       #CONTROLLA
            type: iri
        - [arco-lite:hasArchivialCreator,"https://w3id.org/italia/cultural-heritage/archives/data/agent/$(relations/relation/relationentry[@localtype='soggettoProduttore']/@id)~iri"]                              #problema, c'è una entry in più
        #- [a-cd:hasResponsibility, "https://w3id.org/italia/cultural-heritage/archives/data/archivial-responsibility/$(did/unitid[1])-$(relations/relation[@relationtype='cpfrelation']/relationentry)~iri"]     #aggiungere al posto di archivial-holder id complesso archivistico e - id soggett conservatore
        - p: a-cd:hasResponsibility
          o:
            function: fno:concat
            parameters:
            - [fno:str, "https://w3id.org/italia/cultural-heritage/archives/data/archivial-responsibility/$(did/unitid[1])-" ]
            - parameter: fno:otherStr
              value:
                function: grel:array_get
                parameters:
                - parameter: grel:p_array_a
                  value: 
                      function: grel:string_split
                      parameters:
                      - [grel:valueParameter,"$(relations/relation[@relationtype='cpfrelation']/relationentry[@localtype='Soggetto conservatore'])"]
                      - [grel:p_string_sep, \.]
                - [grel:param_int_i_from,3]
            type: iri
        - [a-cd:hasResponsibility, "https://w3id.org/italia/cultural-heritage/archives/data/archivial-responsibility/$(did/unitid[1])-$(relations/relation[@relationtype='cpfrelation']/relationentry/@id)~iri"]     #aggiungere al posto di archivial-holder id complesso archivistico e - id soggett conservatore 
        - p: Arco4Archive:hasProject
          o:
            function: fno:concat
            parameters:
            - [fno:str,"https://w3id.org/italia/cultural-heritage/archives/data/archivial-resource-set/project/"]
            - parameter: fno:otherStr
              value:
                function: fno:slugify
                parameters:
                - [fno:str, "$(relations/relation[@otherrelationtype='ProgettoCollegato']/relationentry)"]
            type: iri 
        - p: Arco4Archive:hasEvent
          o:
            function: fno:concat
            parameters:
            - [fno:str,"https://w3id.org/italia/cultural-heritage/archives/data/archivial-resource-set/event/"]
            - parameter: fno:otherStr
              value:
                function: fno:slugify
                parameters:
                - [fno:str, "$(relations/relation[@otherrelationtype='EventoCollegato']/relationentry)"]
            type: iri 
        - [sm:URL, "$(bibliography/p/ref/@href)~iri"]

# ci sarebbe una relazione con strumenti di ricerca che non vedo nel grafo        #FindingAid, è identificato dalla stringa md5 della  bibref, i tag non sono standard, notificare, facciamo oppure uri univoci con md5 anche dell'id, vedere come posso prendere sempre il primo figlio dell'xml
# ci sarebbe una relazione con bib che non vedo nel grafo                         #publication, hasReference, URI namespace data /publication/identificativo con solo il numero
    ArchivialResourceSetSR:
      sources:
      - data6
      s: "https://w3id.org/italia/cultural-heritage/archives/data/archivial-resource-set/$(preceding::did/unitid[1])/"
      po:
      - [a, Arco4Archive:ArchivialResourceSet]  
      - p: Arco4Archive:isDescribedBy
        o: 
              function: grel:array_join
              parameters:
              - [grel:p_array_a,"https://w3id.org/italia/cultural-heritage/archives/data/finding-aid/"]
              - parameter: grel:p_array_a
                value:
                  function: grel:string_md5
                  parameters:
                  - [grel:valueParameter, "$(./*[1])"]
              type: iri
    
    
    ArchivialResourceSetExt:
      sources:
      - data2
      s: "https://w3id.org/italia/cultural-heritage/archives/data/archivial-resource-set/$(ancestor::did/unitid[1])/"
      po:
      - [a, Arco4Archive:ArchivialResourceSet]  
      - p: Arco4Archive:hasExtent
        o:
                function: grel:array_join
                parameters:
                - [grel:p_array_a,"https://w3id.org/italia/cultural-heritage/archives/data/extent/"]    #Risolto problema sovrascrizione
                - parameter: grel:p_array_a
                  value:
                    function: grel:string_md5
                    parameters:
                    - parameter: grel:valueParameter
                      value:
                        function: grel:array_join
                        parameters: 
                        - [grel:p_array_a,"$(unittype)"] 
                        - [grel:p_array_a,"$(quantity)"] 
                type: iri

    ArchivialResourceSetTopic:
      sources:
      - data5
      s: "https://w3id.org/italia/cultural-heritage/archives/data/archivial-resource-set/$(preceding::did/unitid[1])/"
      po:
      - [a, Arco4Archive:ArchivialResourceSet]  
      - p: l0:hasTopic
        o:
                function: grel:array_join
                parameters:
                - [grel:p_array_a,"https://w3id.org/italia/cultural-heritage/archives/data/extent/"]    #Risolto problema sovrascrizione
                - parameter: grel:p_array_a
                  value:
                    function: fno:slugify
                    parameters:
                    - [fno:str,"$(part)"] 
                type: iri

    ArchivialResourceSetArrang:
      sources:
      - data4
      s: "https://w3id.org/italia/cultural-heritage/archives/data/archivial-resource-set/$(preceding::did/unitid[1])/"
      po:
      - [a, Arco4Archive:ArchivialResourceSet]
      - p: Arco4Archive:hasArrangement                        #risolto problema sovrascrizione      #Visto che l'arrangement è solo uno, colleghiamo tutto a lui
        o: 
              function: grel:array_join
              parameters:
              - [grel:p_array_a,"https://w3id.org/italia/cultural-heritage/archives/data/arrangement/"]
              - parameter: grel:p_array_a
                value:
                  function: grel:string_md5
                  parameters:
                  - parameter: grel:valueParameter
                    value:
                      function: grel:array_join
                      parameters: 
                      - [grel:p_array_a, "$(../did/unitid[1])"]                          #provato ad usare ancestor anche qui, nei loro esempi funziona, a me no, nella source si
                      - [grel:p_array_a,"$(p/num)"]                                     #ho provato ad aggiornare il parser, ma nulla, l'unica variabile di differenza forse è docker, proverò, intanto risolto con path
                      - [grel:p_array_a,"$(list/item)"] 
              type: iri
    
    ResponsibilityC:         #Fare meglio un agent ha una responsabilità nel tempo riferirsi solo a quell'attore
      sources:
      - data7
      s: "https://w3id.org/italia/cultural-heritage/archives/data/archivial-responsibility/$(preceding::did/unitid[1])-$(relationentry/@id)"     #aggiungere al posto di archivial-holder id complesso archivistico e - id soggett conservatore 
      po:
      - [a, a-cd:Responsibility]
      - [rdfs:label, "Responsabilità archivistica della risorsa $(../did/unitid[1])"]
      - [a-cd:hasAgentWithResponsibility, "https://w3id.org/italia/cultural-heritage/archives/data/agent/$(.[@relationtype='cpfrelation']/relationentry[@localtype='soggettoProduttore']/@id)~iri"]
      - p: a-cd:hasInterventionRole
        o:  "https://w3id.org/italia/cultural-heritage/archives/data/role/ArchivialCreator~iri"
        condition:
          function: equal
          parameters:
          - [str1, "$(.[@relationtype='cpfrelation']/relationentry[@localtype='soggettoProduttore']/@localtype)",s]
          - [str2, "soggettoProduttore",o]
      - p: ti:atTime
        o:
          function: fno:concat
          parameters:
          - [fno:str, "https://w3id.org/italia/cultural-heritage/archives/data/responsibility-time-interval/$(daterange/fromdate)-"] #necessario controllo cpfrelation per sicurezza
          - [fno:otherStr, $(daterange/todate)]
          type: iri

    ResponsibilityH:                                               
        sources:
        - data7
        s: 
            function: fno:concat
            parameters:
            - [fno:str, "https://w3id.org/italia/cultural-heritage/archives/data/archivial-responsibility/$(preceding::did/unitid[1])-" ]
            - parameter: fno:otherStr
              value:
                function: grel:array_get
                parameters:
                - parameter: grel:p_array_a
                  value: 
                      function: grel:string_split
                      parameters:
                      - [grel:valueParameter,"$(../relation[@relationtype='cpfrelation']/relationentry[@localtype='Soggetto conservatore'])"]
                      - [grel:p_string_sep, \.]
                - [grel:param_int_i_from,3]                  
        po:
        - [a, a-cd:Responsibility]
        - [rdfs:label, "Responsabilità archivistica della risorsa $(../did/unitid[1])"]
        - [a-cd:hasAgentWithResponsibility, "https://w3id.org/italia/cultural-heritage/archives/data/agent/$(.[@relationtype='cpfrelation']/relationentry[@localtype='Soggetto conservatore'])~iri"] #si potrebbe splittare anche qui come nel soggeto
        - p: a-cd:hasInterventionRole
          o:  "https://w3id.org/italia/cultural-heritage/archives/data/role/ArchivialHolder~iri"
          condition:
            function: equal
            parameters:
            - [str1, "$(.[@relationtype='cpfrelation']/relationentry[@localtype='Soggetto conservatore']/@localtype)",s]      #non è necessario perché sono divise ma è un double check
            - [str2, "Soggetto conservatore",o]
        - [ti:atTime,"https://w3id.org/italia/cultural-heritage/archives/data/responsibility-time-interval/$(datesingle[@localtype='data aperta'])9999~iri"]  #caso data aperta

    FindingAid:
      sources:
      - data6
      s:
              function: grel:array_join
              parameters:
              - [grel:p_array_a,"https://w3id.org/italia/cultural-heritage/archives/data/finding-aid/"]
              - parameter: grel:p_array_a
                value:
                  function: grel:string_md5
                  parameters:
                  - [grel:valueParameter, "$(./*[1])"]
      po:
      - [a, Arco4Archive:FindingAid] 
      - [rdfs:label, "Strumento di ricerca della risorsa $(../did/unitid[1])"]   
      - [l0:name,"$(./*[1])"]
      - [core:description, "Qualifica del collegamento : $(./*[2]/p)"]    

    ConditionOfAccess: 
      sources:
      - data1
      s:
            function: fno:concat
            parameters: 
            - [fno:str, https://w3id.org/italia/cultural-heritage/archives/data/condition-of-access/]
            - parameter: fno:otherStr
              value:
                function: grel:string_md5
                parameters:
                - [grel:valueParameter:str, "$(accessrestrict/accessrestrict[@localtype='noteCondizioniAccesso']/p)"]    
      po:
      - [a, Arco4Archive:ConditionOfAccess] 
      - [rdfs:label, "Condizioni di accesso della risorsa $(did/unitid[1])"]
      - [core:note,"$(accessrestrict/accessrestrict[@localtype='noteCondizioniAccesso']/p)" ] 
      - p: core:hasType
        o:
            function: fno:concat
            parameters: 
            - [fno:str, https://w3id.org/italia/cultural-heritage/archives/data/type-of-access/]
            - parameter: fno:otherStr
              value:
                function: fno:slugify
                parameters:
                - [fno:str, "$(accessrestrict/p)"]            #Interpretato come una lista chiusa magari
            type: iri

    ConditionOfUse:
      sources:
      - data1
      s:
            function: fno:concat
            parameters: 
            - [fno:str, https://w3id.org/italia/cultural-heritage/archives/data/condition-of-use/]
            - parameter: fno:otherStr
              value:
                function: grel:string_md5
                parameters:
                - [grel:valueParameter:str, "$(userrestrict/userrestrict[@localtype='noteCondizioniUtilizzo']/p)"] 
      po:
      - [a, Arco4Archive:ConditionOfUse]
      - [rdfs:label,"Condizioni di utilizzo della risorsa $(did/unitid[1])"]
      - [core:note,"$(userrestrict/userrestrict[@localtype='noteCondizioniUtilizzo']/p)" ] 
      - p: core:hasType
        o:
            function: fno:concat
            parameters: 
            - [fno:str, https://w3id.org/italia/cultural-heritage/archives/data/type-of-use/]
            - parameter: fno:otherStr
              value:
                function: fno:slugify
                parameters:
                - [fno:str, "$(userrestrict/p)"]            #Interpretato come una lista chiusa magari
            type: iri  

    
    DesignationInTime:
      sources:
      - data1
      s: 
            function: fno:concat
            parameters:
              - [fno:str, "https://w3id.org/italia/cultural-heritage/archives/data/alternative-designation/$(did/unitid[1])-"]
              - parameter: fno:otherStr
                value:
                  function: fno:slugify
                  parameters:
                  - [fno:str, "$(did/unittitle[@label='altraDenominazione'])"]
      po:
      - [a, a-cd:DesignationInTime]
      - p: ti:atTime
        o:
          function: fno:concat
          parameters:
          - [fno:str,https://w3id.org/italia/cultural-heritage/archives/data/time-interval/]
          - parameter: fno:otherStr
            value:
              function: fno:slugify
              parameters:
              - [fno:str, "$(did/unittitle/date)"]
          type: iri
      - [l0:name, "$(did/unittitle[@label='altraDenominazione'])"]


    TimeInterval:
        sources:
        - data1
        s: https://w3id.org/italia/cultural-heritage/archives/data/archivial-resource-set/time-interval/$(did/unitdatestructured/daterange/fromdate)-$(did/unitdatestructured/daterange/todate)
        po:
        - [a, ti:TimeInterval]
        - [ti:hasTimeInstantInside,"https://w3id.org/italia/cultural-heritage/archives/data/time-instant/$(did/unitdatestructured/daterange/fromdate)~iri"] 
        - [ti:hasTimeInstantInside,"https://w3id.org/italia/cultural-heritage/archives/data/time-instant/$(did/unitdatestructured/daterange/todate)~iri"] 
        - [ti:time, "$(did/unitdate[@label='dataTestuale'])"]          #Mi sembrava più corretto qui invece che in DesignationInTime perché credo sia la nota riferita alla data relativa al complesso

    
    TimeIntervalDesignation:
            sources:
            - data1
            s: 
                function: fno:concat
                parameters:
                - [fno:str,https://w3id.org/italia/cultural-heritage/archives/data/time-interval/]
                - parameter: fno:otherStr
                  value:
                    function: fno:slugify
                    parameters:
                    - [fno:str, "$(did/unittitle/date)"]
            po:
            - [a, ti:TimeInterval]
            - p: ti:hasTimeInstantInside
              o: 
                function: fno:concat
                parameters:
                - [fno:str, "https://w3id.org/italia/cultural-heritage/archives/data/time-instant/"]
                - parameter: fno:otherStr
                  value:
                    function: grel:array_get
                    parameters:
                    - parameter: grel:p_array_a
                      value: 
                                function: grel:string_split
                                parameters:
                                - [grel:valueParameter,$(did/unittitle/date)]
                                - [grel:p_string_sep,"-"]
                    - [grel:param_int_i_from,0]
                type: iri
            - p: ti:hasTimeInstantInside
              o: 
                function: fno:concat
                parameters:
                - [fno:str, "https://w3id.org/italia/cultural-heritage/archives/data/time-instant/"]
                - parameter: fno:otherStr
                  value:
                    function: grel:array_get
                    parameters:
                    - parameter: grel:p_array_a
                      value: 
                                function: grel:string_split
                                parameters:
                                - [grel:valueParameter,$(did/unittitle/date)]
                                - [grel:p_string_sep,"-"]
                    - [grel:param_int_i_from,1]
                type: iri
          
    TimeInstantS:       #ti:Time stringa dell'estremo
        sources:
        - data1
        s: https://w3id.org/italia/cultural-heritage/archives/data/time-instant/$(did/unitdatestructured/daterange/fromdate)
        po:
        - [a, ti:TimeInstant]
        - [core:note,"$(did/didnote[@label='Note_a_Estremo_recente_Complesso'])"]
        - [Arco4Archive:inIntervalPosition,"start"]

    TimeInstantE:
        sources:
        - data1
        s: https://w3id.org/italia/cultural-heritage/archives/data/time-instant/$(did/unitdatestructured/daterange/todate)
        po:
        - [a, ti:TimeInstant]
        - [core:note,"$(did/didnote[@label='Note_a_Estremo_remoto_Complesso'])"] #immaginario
        - [Arco4Archive:inIntervalPosition,"end"]

    TimeInstantSDesignation:
        sources:
        - data1
        s: 
                function: fno:concat
                parameters:
                - [fno:str, "https://w3id.org/italia/cultural-heritage/archives/data/designation-time-instant/"]
                - parameter: fno:otherStr
                  value:
                    function: grel:array_get
                    parameters:
                    - parameter: grel:p_array_a
                      value: 
                                function: grel:string_split
                                parameters:
                                - [grel:valueParameter,$(did/unittitle/date)]                                        #risolto problema estrazione indici
                                - [grel:p_string_sep,"-"]
                    - [grel:param_int_i_from,0]
        po:
        - [a, ti:TimeInstant]
        - [Arco4Archive:inIntervalPosition,"start"]

    TimeInstantEDesignation:
        sources:
        - data1
        s: 
                function: fno:concat
                parameters:
                - [fno:str, "https://w3id.org/italia/cultural-heritage/archives/data/designation-time-instant/"]      #ho disambiguato l'URI dall'altro timeinstant per non far confondere start e end
                - parameter: fno:otherStr
                  value:
                    function: grel:array_get
                    parameters:
                    - parameter: grel:p_array_a
                      value: 
                                function: grel:string_split
                                parameters:
                                - [grel:valueParameter,$(did/unittitle/date)]
                                - [grel:p_string_sep,"-"]
                    - [grel:param_int_i_from,1]
        po:
        - [a, ti:TimeInstant]
        - [Arco4Archive:inIntervalPosition,"end"]

    Extent:
        sources:
        - data2
        s: 
                function: grel:array_join
                parameters:
                - [grel:p_array_a,"https://w3id.org/italia/cultural-heritage/archives/data/extent/"]
                - parameter: grel:p_array_a
                  value:
                    function: grel:string_md5
                    parameters:
                    - parameter: grel:valueParameter
                      value:
                        function: grel:array_join
                        parameters: 
                        - [grel:p_array_a,"$(unittype)"] 
                        - [grel:p_array_a,"$(quantity)"]     
        po: 
        - [a, Arco4Archive:Extent]
        - [Arco4Archive:quantity, $(quantity),xsd:integer]                                                          #ci sarà da controllare se sono scritti correttamente
        - [core:note, $(descriptivenote/p),xsd:string]
        - p: Arco4Archive:extentInLinearMeters
          o: $(dimensions)
        - p: core:hasType
          o: 
          - mapping: ConsistencyType                    # posso fare come sopra, ma nei dati è scritto al plurale :( per ora metterò la notation del vocabolario al plurale e in minuscolo
            condition:                                 #capire come fare il matching vocabolario controllato
              function: equal
              parameters:
                - [str1, $(unittype),s]
                - [str2, $(notation),o]
    
    ConservationStatus:
      sources:
      - data1
      s: "https://w3id.org/arco/ontology/denotative-description/ConservationStatus/$(did/unitid[1])"
      po:
      - [a, a-cd:ConservationStatus]
      - [core:specification,"$(did/didnote[@localtype='Restauro_o_Altri_interventi']/p)"]       #potrebbe anche essere ConservationInterention?
      - [Arco4Archive:materialCondition,"$(did/didnote[@localtype='Condizioni_del_materiale']/p)"]
      - [core:hasType,"https://w3id.org/arco/ontology/denotative-description/ConservationStatusType/$(did/didnote[@localtype='Stato_di_conservazione']/p)~iri"] #dobbiamo istanziare anche ConservationStatusType?
      - p: rdfs:label
        o:
          function: fno:concat
          parameters:
          - [fno:str , "Stato di conservazione 1 del bene: "]
          - [fno:otherStr , "$(did/unitid[1])"]

    Arrangement:
      sources:
      - data4
      s: "https://w3id.org/italia/cultural-heritage/archives/data/arrangement/$(preceding::did/unitid[1])/"     #Il codice del bene data/arrangement/codicebene
      po: 
      - [a, Arco4Archive:Arrangement]
      - [rdfs:label,"Criterio di ordinamento $(../did/unitid[1])"]
      - [core:description,"$(p)"]
      - p: Arco4Archive:hasNumbering    
        o: 
          function: grel:array_join
          parameters:
          - [grel:p_array_a,"https://w3id.org/italia/cultural-heritage/archives/data/arrangement/numbering/"]
          - parameter: grel:p_array_a
            value:
              function: grel:string_md5
              parameters:
              - parameter: grel:valueParameter
                value:
                  function: grel:array_join
                  parameters:
                  - [grel:valueParameter,"$(../did/unitid[1])"]  
                  - [grel:valueParameter,"$(p/num)"]
          type: iri

    Numbering:  #rdfs:label, numerazione in $tiponumerazione della risorsa id risorsa
      sources: 
      - data1
      s:     
          function: grel:array_join
          parameters:
          - [grel:p_array_a,"https://w3id.org/italia/cultural-heritage/archives/data/arrangement/numbering/"]
          - parameter: grel:p_array_a
            value:
              function: grel:string_md5
              parameters:
              - parameter: grel:valueParameter
                value:
                  function: grel:array_join
                  parameters:
                  - [grel:valueParameter,"$(did/unitid[1])"]  
                  - [grel:valueParameter,"$(arrangement/p/num)"]
      po: 
      - [a, Arco4Archive:Numbering]  
      - [rdfs:label,"Numerazione in $(arrangement/p/num) della risorsa $(did/unitid[1])"]
      - [core:description, $(arrangement/list/item)]      
      - p: Arco4Archive:hasNumberingType
        o: "https://w3id.org/italia/cultural-heritage/archives/data/arrangement/numbering-type/arabic-numeral~iri"
        condition:
                function: idlab-fn:equal
                parameters:
                - [grel:valueParameter,$(arrangement/p/num)]
                - [grel:valueParameter2,"numeri arabi"]
      - p: Arco4Archive:hasNumberingType
        o: "https://w3id.org/italia/cultural-heritage/archives/data/arrangement/numbering-type/roman-numeral~iri"
        condition:
                function: idlab-fn:equal
                parameters:
                - [grel:valueParameter,$(arrangement/p/num)]
                - [grel:valueParameter2,"numeri romani"]                                                #diciture supposte nei futuri dati
      - p: Arco4Archive:hasNumberingType
        o: "https://w3id.org/italia/cultural-heritage/archives/data/arrangement/numbering-type/alphanumerical~iri"
        condition:
                function: idlab-fn:equal
                parameters:
                - [grel:valueParameter,$(arrangement/p/num)]
                - [grel:valueParameter2,"numeri alfanumerici"] 

    LevelOfDescription:
      sources:
      - archivalHierarchy
      s: $(URI)

    ConsistencyType:
      sources:
      - archivesConsistency
      s: "http://example/archives-consistency-type/$(notation)"





#Problema identificativo originali
#original e identificativo fondo o copy
#fondo levelofdescription
  
